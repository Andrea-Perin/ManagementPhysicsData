# About SSO:

* go to link (https://www.digicert.com/secure/saml/discovery/?entityID=https%3A%2F%2Fwww.digicert.com%2Fsso&returnIDParam=idp) using a non Chrome browser
* select universita' di Padova
* accept (even without trusting) and then go back. You will find a certificate in one of the previous pages.
* three files can be downloaded. One of them is actually our certificate (+ private key), the others are just files referring back to the organizations providing the certificate
* install the certificate.

What is the purpose of this certificate? If a site requires a certificate and it trusts the authority that issues it, we can then access to that service. For now, however, we can not actually do much w/ this certificate.

####################

# scp command: remote copy on a gate (home directory)

	echo "Andrea Perin" > myfile.txt
	cat myfile.txt
	scp myfile.txt aperin@gate.cloudveneto.it:~/ 

####################

# environment variables: variables that are initialized when we start our session; for example, inside $HOME there is the name/path of the folder that is set as home

	echo $HOME

####################

# logging in our gate

	ssh -t -l 1238:localhost:1238 aperin@gate.cloudveneto.it

####################

# copying the certificate in the gate home directory

	scp /home/perina/Management/scampana/certificate/perin_andrea_andrea_perin_10_studenti_unipd_it/perin_andrea_andrea_perin_10_studenti_unipd_it.crt aperin@gate.cloudveneto.it:~/

####################

# about kerberos authentication system

Kerberos used to issue challenges in the traditional way: Bob asks Alice to encrypt a message, if she passes the test then she is actually Alice. However, such system is faulty (it is weak to a reflection attack). Instead, now kerberos uses a different method.

####################

# authorization

Kerberos also has an authorization system. 
If we write in the terminal

	ls -l

we will see the following:

drwxr-xr-x 5 perina fisica  260 May 16 18:06 adv stat
drwxr-xr-x 2 perina fisica    6 Mar 11 17:16 Desktop
drwxr-xr-x 2 perina fisica  113 Apr  2 18:59 Documents
drwx------ 7 perina fisica 4096 May 23 08:56 Downloads
-rw-r--r-- 1 perina fisica    0 May 16 13:34 global.lock
drwxr-xr-x 5 perina fisica  186 Apr  8 17:35 labcompb
drwxr-xr-x 4 perina fisica   37 May 10 12:09 Management
drwxr-xr-x 2 perina fisica    6 Oct  1  2018 Music
-rw-r--r-- 1 perina fisica   13 May 23 09:14 myfile.txt
drwxr-xr-x 2 perina fisica    6 Oct  1  2018 Pictures
drwxr-xr-x 2 perina fisica    6 Oct  1  2018 Public
-rw-r--r-- 1 perina fisica    0 May 16 13:34 purge.lock
drwxr-xr-x 3 perina fisica   41 Oct  8  2018 R
drwxr-xr-x 2 perina fisica    6 Oct  1  2018 Templates
drwxr-xr-x 2 perina fisica    6 Oct  1  2018 Videos
drwx------ 3 perina fisica   21 May 16 15:19 worker-e4xkmtsj
-rw-r--r-- 1 perina fisica    0 May 16 15:19 worker-e4xkmtsj.dirlock
drwx------ 3 perina fisica   21 May 16 15:19 worker-mqvicvw4
-rw-r--r-- 1 perina fisica    0 May 16 15:19 worker-mqvicvw4.dirlock
drwx------ 3 perina fisica   21 May 16 15:19 worker-wfxduhp7
-rw-r--r-- 1 perina fisica    0 May 16 15:19 worker-wfxduhp7.dirlock
drwx------ 3 perina fisica   21 May 16 15:19 worker-z5wszrs_
-rw-r--r-- 1 perina fisica    0 May 16 15:19 worker-z5wszrs_.dirlock

by column:
* the first string of chars tells us if: 
	- the file is a directory (d) or a file (-)
	- the following 9 chars, instead, tell us the permissions: reading (r), writing (w) and executing (x). The three `rwx` refer respectively to user, group and other.

* the number (not explained)
* the user (in this case `perina`)
* the group to which the user belongs (in this case `fisica`)
* others...

We can use the command `chmod` to change the permissions; for example

	echo "huivhjhuvjjhbvb" > cose.txt
	ls -l
	chmod g+w cose.txt
	ls -l

We can also remove authorizations by using '-' instead of '+'.
Before and After:

-rw-r--r-- 1 perina fisica   16 May 23 10:08 cose.txt		
-rw-rw-r-- 1 perina fisica   16 May 23 10:08 cose.txt


In order to change more than one at a time, we can use the compact form of the command, which employs a numerical input.

	chmod 666 cose.txt

Use the following map to interpret it.

permission to:  user(u)   group(g)   other(o)     
                /¯¯¯\      /¯¯¯\      /¯¯¯\
octal:            6          6          6
binary:         1 1 0      1 1 0      1 1 0
what to permit: r w x      r w x      r w x

binary         - 1: enabled, 0: disabled

what to permit - r: read, w: write, x: execute

permission to  - user: the owner that create the file/folder
                 group: the users from group that owner is member
                 other: all other users

################################################################################

Enter in VM as root  

ssh -t -l 1234:localhost:1234 aperin@gate.cloudveneto.it 				# logging in the system

scp perin_andrea_andrea_perin_10_studenti_unipd_it.crt andreaperin@10.67.22.14:~/	# putting the certificate in the VM; from there, it 

ssh root@10.67.22.14 									# entering in the VM as root

cd /home/andreaperin									# getting to my folder

git clone https://github.com/marcoverl/training.git					# getting the proper files

sudo -u andreaperin /bin/bash								# sudo->makes you switch user; you become andreaperin; /bin/bash opens another terminal. However, we are having root privileges, so that we can do whatever we want

whoami											# returns the state; IMPORTANT: once we are no more root (e.g. we have become andreaperin), we may no more be able to do some things

exit											# back to root mode

cd training/Grid									# accessing the right folder we just downloaded

source setup-cvmfs.sh									# we can not simply execute it; permission denied. This is because we do not have the authorizations needed. IMPORTANT: source takes the file and runs each of its lines in the terminal, without opening some separate process in which to run everything. In order to make this file executable, use chmod. What is cvmfs? CernVM File System (CernVM-FS) is a network file system based on HTTP and optimized to deliver experiment software in a fast, scalable, and reliable way. 

chmod 777 setup-cvmfs.sh
./setup-cvmfs.sh

chmod 777 setup-euindia-vo.sh
./setup-euindia-vo.sh

chmod 777 setup-x509.sh
./setup-x509.sh

sudo -u andreaperin /bin/bash

cd											# now we're in the home of andreaperin, not the one of the root

scp pippo@10.67.22.26:/tmp/userkey.pem .						# copying from ... to ... in this case from pippo to me

scp pippo@10.67.22.26:/tmp/usercert.pem .

ls -al											# look at all files, also hidden ones. Find the directory .globus

cp usercert.pem .globus
cp userkey.pem .globus
cd .globus/

ls -al

chmod 400 usercert.pem									# setting the proper authorizations (of course
chmod 400 userkey.pem

cd

cd training/
cd Grid/
export VOMS_USERCONF=$PWD/etc/grid-security/vomses X509_VOMS_DIR=$PWD/etc/grid-security/vomsdir
export LCG_GFAL_INFOSYS=lcg-bdii.cern.ch:2170

voms-proxy-init -voms euindia								# but credentials could not be loaded. No adequate permissions
##########################################
#                                        # 
#   a cosa sono serviti i certificati?   #
#   a cosa servono i comandi lcg?        #
#                                        #
##########################################
